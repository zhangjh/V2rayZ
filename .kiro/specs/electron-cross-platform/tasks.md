# 实施计划

- [x] 1. 项目初始化和基础架构搭建
- [x] 1.1 创建 Electron 项目结构
  - 初始化 npm 项目（package.json）
  - 创建目录结构：src/main（主进程）、src/renderer（渲染进程）、src/shared（共享代码）
  - 创建 resources 目录用于存放二进制文件和资源
  - _需求: 12.1_

- [x] 1.2 配置 TypeScript

  - 安装 TypeScript 和类型定义（@types/node, @types/electron）
  - 配置 tsconfig.json（主进程和渲染进程分别配置）
  - 配置 ESLint 和 Prettier
  - _需求: 12.1_

- [x] 1.3 配置构建工具
  - 配置主进程构建（使用 tsc 或 esbuild）
  - 配置渲染进程构建（使用 Vite）
  - 配置 electron-builder 打包配置
  - 配置 package.json scripts（dev, build, package）
  - _需求: 12.1_

- [x] 1.4 配置开发环境
  - 配置主进程热重载（electron-reload 或 nodemon）
  - 配置渲染进程热重载（Vite HMR）
  - 配置 VSCode 调试配置（.vscode/launch.json）
  - _需求: 12.1_

- [-] 2. 实现 IPC 通信层
- [x] 2.1 定义 IPC 通道常量和类型
  - 创建 `src/shared/ipc-channels.ts` 定义所有通道名称
  - 创建 `src/shared/types.ts` 定义共享类型
  - _需求: 1.2_

- [x] 2.2 实现主进程 IPC 处理器注册
  - 创建 IPC 处理器注册函数
  - 实现错误处理和响应包装
  - _需求: 1.2_

- [x] 2.3 实现渲染进程 IPC 客户端
  - 创建类型安全的 IPC 调用封装
  - 实现事件监听器管理
  - _需求: 1.2_

- [x] 2.4 编写属性测试验证 IPC 往返一致性
  - **属性 1: IPC 通信往返一致性**
  - **验证: 需求 1.2**

- [x] 3. 实现配置管理服务
- [x] 3.1 实现 ConfigManager 核心逻辑
  - 实现配置文件读写
  - 实现配置验证逻辑
  - 实现默认配置生成
  - _需求: 4.1, 4.2, 4.3_

- [x] 3.2 编写属性测试验证配置验证和保存
  - **属性 12: 配置验证和保存**
  - **验证: 需求 4.2**

- [x] 3.3 编写属性测试验证配置往返一致性
  - **属性 13: 配置往返一致性**
  - **验证: 需求 4.3**

- [x] 3.4 编写属性测试验证配置文件权限
  - **属性 14: 配置文件权限保护**
  - **验证: 需求 4.5**

- [x] 3.5 实现配置 IPC 接口
  - 注册 config:get 处理器
  - 注册 config:save 处理器
  - 注册 config:updateMode 处理器
  - _需求: 4.2_

- [x] 4. 实现协议解析服务
- [x] 4.1 实现 ProtocolParser 核心逻辑
  - 实现 VLESS URL 解析
  - 实现 Trojan URL 解析
  - 实现传输层配置解析
  - 实现 TLS 配置解析
  - _需求: 8.1, 8.2, 8.4, 8.5_

- [x] 4.2 编写属性测试验证 VLESS 解析正确性
  - **属性 25: VLESS URL 解析正确性**
  - **验证: 需求 8.1**

- [x] 4.3 编写属性测试验证 Trojan 解析正确性
  - **属性 26: Trojan URL 解析正确性**
  - **验证: 需求 8.2**

- [x] 4.4 编写属性测试验证传输层配置解析
  - **属性 27: 传输层配置解析**
  - **验证: 需求 8.4**

- [x] 4.5 编写属性测试验证 TLS 配置解析
  - **属性 28: TLS 配置解析**
  - **验证: 需求 8.5**

- [x] 4.6 实现协议解析 IPC 接口
  - 注册 server:parseUrl 处理器
  - 注册 server:addFromUrl 处理器
  - _需求: 8.1, 8.2_

- [x] 5. 实现路由规则管理服务
- [x] 5.1 实现 RoutingRuleManager 核心逻辑
  - 实现全局代理模式规则生成
  - 实现智能分流模式规则生成
  - 实现自定义域名规则集成
  - _需求: 9.1, 9.2, 9.3_

- [x] 5.2 编写属性测试验证自定义规则集成
  - **属性 29: 自定义域名规则集成**
  - **验证: 需求 9.3**

- [x] 5.3 编写属性测试验证规则修改触发重启
  - **属性 30: 路由规则修改触发重启**
  - **验证: 需求 9.4**

- [x] 6. 实现平台抽象层 - 系统代理
- [x] 6.1 实现 Windows 系统代理管理
  - 实现注册表读写逻辑
  - 实现代理启用/禁用
  - 实现代理状态查询
  - _需求: 6.1_

- [x] 6.2 实现 macOS 系统代理管理
  - 实现 networksetup 命令调用
  - 实现代理启用/禁用
  - 实现代理状态查询
  - _需求: 6.2_

- [x] 6.3 实现系统代理工厂函数
  - 根据平台返回对应实现
  - _需求: 3.1_

- [x] 6.4 编写属性测试验证平台特定方法调用
  - **属性 7: 平台特定的系统代理方法**
  - **验证: 需求 3.1**

- [x] 6.5 编写属性测试验证代理往返恢复
  - **属性 19: 系统代理往返恢复**
  - **验证: 需求 6.3**

- [x] 6.6 编写属性测试验证代理状态查询准确性
  - **属性 20: 代理状态查询准确性**
  - **验证: 需求 6.5**

- [ ] 7. 实现平台抽象层 - 自启动管理
- [x] 7.1 实现 Windows 自启动管理
  - 实现注册表启动项添加/删除
  - 实现自启动状态查询
  - _需求: 11.1_

- [x] 7.2 实现 macOS 自启动管理
  - 使用 Electron app.setLoginItemSettings
  - 实现自启动状态查询
  - _需求: 11.2_

- [x] 7.3 实现自启动工厂函数
  - 根据平台返回对应实现
  - _需求: 3.3_

- [x] 7.4 编写属性测试验证自启动往返一致性
  - **属性 32: 自启动往返一致性**
  - **验证: 需求 11.3**

- [x] 7.5 编写属性测试验证自启动状态查询准确性
  - **属性 33: 自启动状态查询准确性**
  - **验证: 需求 11.4**

- [ x] 8. 实现日志管理服务
- [ x] 8.1 实现 LogManager 核心逻辑
  - 实现日志记录和存储
  - 实现日志文件轮转
  - 实现日志查询
  - 实现日志级别过滤
  - _需求: 7.1, 7.2, 7.3, 7.5_

- [x] 8.2 编写属性测试验证日志写入和转发
  - **属性 21: 日志写入和转发**
  - **验证: 需求 7.1**

- [x] 8.3 编写属性测试验证日志查询返回最近条目
  - **属性 22: 日志查询返回最近条目**
  - **验证: 需求 7.3**

- [x] 8.4 编写属性测试验证错误日志包含堆栈
  - **属性 23: 错误日志包含堆栈信息**
  - **验证: 需求 7.4**

- [x] 8.5 编写属性测试验证日志级别动态调整
  - **属性 24: 日志级别动态调整**
  - **验证: 需求 7.5**

- [x] 8.6 实现日志 IPC 事件推送
  - 实现 event:logReceived 事件发送
  - _需求: 7.1_

- [x] 9. 实现代理管理服务
- [x] 9.1 实现 sing-box 配置生成
  - 实现系统代理模式配置生成（HTTP/SOCKS inbound）
  - 实现 TUN 模式配置生成（TUN inbound，需要管理员权限）
  - 实现 VLESS outbound 配置生成
  - 实现 Trojan outbound 配置生成
  - 集成 RoutingRuleManager 生成路由规则
  - 实现配置文件写入到用户数据目录
  - _需求: 5.1_

- [x] 9.1.1 实现进程生命周期管理
  - 实现 sing-box 进程启动（使用 child_process.spawn）
  - 实现进程 PID 和启动时间记录
  - 实现进程状态查询（运行中/已停止）
  - 实现进程优雅停止（SIGTERM + 超时后 SIGKILL）
  - 实现进程重启逻辑
  - _需求: 2.2, 2.3, 5.2, 5.4_

- [x] 9.2 编写属性测试验证代理配置生成和进程启动
  - **属性 15: 代理配置生成和进程启动**
  - **验证: 需求 5.1**

- [x] 9.3 编写属性测试验证进程状态监控
  - **属性 16: 进程状态监控**
  - **验证: 需求 5.2**

- [x] 9.4 编写属性测试验证进程优雅终止
  - **属性 18: 进程优雅终止**
  - **验证: 需求 5.4**

- [x] 9.5 实现 sing-box 日志捕获和解析
  - 监听进程 stdout 和 stderr
  - 移除 ANSI 颜色代码
  - 解析 sing-box 日志级别（INFO/WARN/ERROR/FATAL）
  - 解析错误信息并转换为友好的中文提示
  - 转发日志到 LogManager
  - 实现重复日志过滤（避免日志刷屏）
  - _需求: 2.4_

- [x] 9.6 编写属性测试验证日志捕获和转发
  - **属性 6: 日志捕获和转发**
  - **验证: 需求 2.4**

- [x] 9.7 实现进程异常退出处理
  - 监听 exit 事件
  - 解析退出原因
  - 发送错误事件到前端
  - _需求: 2.5_

- [x] 9.8 实现代理模式切换逻辑
  - 检测模式变化
  - 重新生成配置
  - 重启进程
  - _需求: 5.3_

- [x] 9.9 编写属性测试验证代理模式切换重启
  - **属性 17: 代理模式切换重启**
  - **验证: 需求 5.3**

- [x] 9.10 实现代理 IPC 接口
  - 注册 proxy:start 处理器
  - 注册 proxy:stop 处理器
  - 注册 proxy:getStatus 处理器
  - 实现事件推送（started/stopped/error）
  - _需求: 2.2, 2.3_

- [x] 9.11 编写属性测试验证代理启动生成正确进程
  - **属性 4: 代理启动生成正确的进程**
  - **验证: 需求 2.2**

- [x] 9.12 编写属性测试验证代理停止清理资源
  - **属性 5: 代理停止清理所有资源**
  - **验证: 需求 2.3**

- [x] 10. 检查点 - 确保所有后端服务测试通过
  - 确保所有测试通过，如有问题请询问用户

- [-] 11. 迁移 React 前端代码
- [x] 11.1 复制现有 React 组件到 Electron 项目
  - 复制 src/components 目录
  - 复制 src/lib、src/hooks、src/stores
  - 复制 src/types
  - _需求: 1.1, 1.3_

- [x] 11.2 创建 IPC 客户端封装
  - 创建 src/renderer/api/ipc-client.ts
  - 封装所有 IPC 调用方法（startProxy, stopProxy, getConfig, saveConfig 等）
  - 实现类型安全的 API 接口
  - 实现错误处理和重试逻辑
  - _需求: 1.2_

- [x] 11.2.1 替换前端 API 调用
  - 查找所有 window.nativeApi 调用
  - 替换为 IPC 客户端方法调用
  - 更新事件监听逻辑（从 window.addEventListener 改为 ipcRenderer.on）
  - 测试所有 API 调用是否正常工作
  - _需求: 1.2, 1.4_

- [x] 11.3 编写属性测试验证 UI 交互触发正确操作
  - **属性 2: UI 交互触发正确的后端操作**
  - **验证: 需求 1.4**

- [x] 11.4 配置 Vite 用于 Electron 渲染进程
  - 配置 base 路径
  - 配置构建输出目录
  - _需求: 1.1_

- [x] 12. 实现主进程窗口管理
- [x] 12.1 实现主窗口创建和配置
  - 创建 BrowserWindow
  - 配置窗口大小和属性
  - 加载 React 应用
  - _需求: 1.1_

- [x] 12.2 实现窗口关闭行为
  - 监听 close 事件
  - 根据配置决定隐藏或退出
  - _需求: 1.5_

- [x] 12.3 编写属性测试验证窗口关闭行为
  - **属性 3: 窗口关闭行为遵循配置**
  - **验证: 需求 1.5**

- [x] 13. 实现系统托盘集成
- [x] 13.1 实现托盘图标创建
  - 创建 Tray 对象
  - 设置托盘图标（Windows/macOS）
  - _需求: 10.1_

- [x] 13.2 实现托盘上下文菜单
  - 创建菜单项（启动/停止代理、显示窗口、退出）
  - 绑定菜单项点击事件
  - _需求: 10.2_

- [x] 13.3 实现托盘图标状态更新
  - 根据代理状态更新图标
  - _需求: 10.3_

- [x] 13.4 编写属性测试验证跨平台托盘菜单一致性
  - **属性 8: 跨平台托盘菜单一致性**
  - **验证: 需求 3.2**

- [x] 13.5 编写属性测试验证托盘操作触发正确行为
  - **属性 31: 托盘操作触发正确行为**
  - **验证: 需求 10.3**

- [x] 14. 准备跨平台资源文件
- [x] 14.1 下载和准备 Windows 平台资源
  - 下载 Windows 版本 sing-box.exe，已经放置在了目录V2rayClient/Resources下，Windows为sing-box-1.12.12-windows-amd64下，mac在同级目录sing-box-1.12.12-darwin-amd64和sing-box-1.12.12-darwin-arm64
  - 验证 sing-box.exe 可执行性
  - 准备 Windows 应用图标（.ico），放置在V2rayClient/Resources下，app.icns以及app.ico
  - 准备 Windows 托盘图标（16x16, 32x32 PNG）
  - 放置到 resources/win 目录
  - _需求: 3.5, 10.1_

- [x] 14.2 下载和准备 macOS Intel (x64) 平台资源
  - 下载 macOS x64 版本 sing-box（无扩展名可执行文件）
  - 验证 sing-box 可执行性和权限（chmod +x）
  - 准备 macOS 应用图标（.icns）
  - 准备 macOS 托盘图标（16x16@2x, 32x32@2x PNG）
  - 放置到 resources/mac-x64 目录
  - _需求: 3.5, 10.1_

- [x] 14.2.1 下载和准备 macOS Apple Silicon (arm64) 平台资源
  - 下载 macOS arm64 版本 sing-box（无扩展名可执行文件）
  - 验证 sing-box 可执行性和权限（chmod +x）
  - 复用 macOS 应用图标和托盘图标
  - 放置到 resources/mac-arm64 目录
  - _需求: 3.5, 10.1_

- [x] 14.3 准备 GeoIP 和 GeoSite 数据文件
  - 下载 geoip.db 或 geoip.dat
  - 下载 geosite.db 或 geosite.dat
  - 放置到 resources/data 目录
  - 配置 sing-box 使用这些数据文件
  - _需求: 9.2_

- [x] 14.4 实现资源文件管理器
  - 实现 ResourceManager 类
  - 根据 process.platform 和 process.arch 返回对应平台和架构的资源路径
  - Windows: resources/win/sing-box.exe
  - macOS Intel: resources/mac-x64/sing-box
  - macOS Apple Silicon: resources/mac-arm64/sing-box
  - 处理开发环境（未打包）和生产环境（打包后）路径差异
  - 实现资源文件存在性检查和错误提示
  - _需求: 3.5_

- [x] 14.5 编写属性测试验证平台特定二进制加载
  - **属性 11: 平台特定的二进制文件加载**
  - **验证: 需求 3.5**

- [x] 15. 配置构建和打包
- [x] 15.1 配置 electron-builder
  - 创建 electron-builder.json 或在 package.json 中配置
  - 配置应用 ID、名称、版本、描述
  - 配置 Windows 打包（NSIS 安装程序，包含卸载程序，target: nsis）
  - 配置 macOS 打包（DMG 镜像，包含拖拽安装）
  - 配置 macOS 通用二进制（Universal Binary）支持 Intel 和 Apple Silicon
  - 或者分别打包 x64 和 arm64 版本（target: ['dmg:x64', 'dmg:arm64']）
  - 配置文件包含规则（resources 目录、node_modules 等）
  - 配置文件排除规则（源代码、开发依赖等）
  - 配置平台和架构特定的资源文件路径映射
  - _需求: 12.2, 12.3, 12.4, 12.5_

- [x] 15.2 编写属性测试验证打包产物包含必要文件
  - **属性 34: 打包产物包含必要文件**
  - **验证: 需求 12.4**

- [x] 15.3 编写属性测试验证打包输出包含版本信息
  - **属性 35: 打包输出包含版本信息**
  - **验证: 需求 12.5**

- [x] 15.4 配置多种打包格式
  - Windows: 配置 NSIS 安装程序（.exe）
  - Windows: 配置便携版（zip 压缩包，免安装）
  - macOS: 配置 DMG 镜像（安装版）
  - macOS: 配置 zip 压缩包（便携版）
  - 在 electron-builder 配置中添加多个 target
  - _需求: 12.2, 12.3_

- [x] 15.5 配置构建脚本
  - 配置前端构建脚本（npm run build:renderer）
  - 配置主进程构建脚本（npm run build:main）
  - 配置完整构建脚本（npm run build）
  - 配置打包脚本（npm run package:win, npm run package:mac）
  - _需求: 12.1_

- [x] 15.6 实现自动发布到 GitHub Release
  - 创建 auto-release.sh 脚本（或 .js/.ts 版本）
  - 实现版本号自动提取（从 package.json）
  - 实现 Git tag 创建和推送
  - 使用 GitHub CLI 或 API 创建 Release
  - 上传所有打包产物（Windows 安装版、Windows 便携版、macOS DMG、macOS zip）
  - 生成 Release Notes（从 CHANGELOG 或 Git commits）
  - 配置 CI/CD（GitHub Actions）自动触发发布流程
  - _需求: 12.5_

- [x] 16. 实现错误处理和恢复
- [x] 16.1 实现全局异常捕获
  - 主进程 uncaughtException 处理
  - 主进程 unhandledRejection 处理
  - 渲染进程错误处理
  - _需求: 13.5_

- [x] 16.2 实现配置加载错误处理
  - 捕获配置文件损坏
  - 使用默认配置
  - 通知用户
  - _需求: 13.1_

- [x] 16.3 实现进程启动错误处理
  - 解析 sing-box 错误输出
  - 提供友好的错误信息
  - _需求: 13.2_

- [x] 16.4 实现系统代理错误处理
  - 保存原始设置
  - 失败时回滚
  - _需求: 13.3_

- [x] 16.5 实现自动重试机制
  - 对临时性错误重试
  - 限制重试次数
  - _需求: 13.4_

- [x] 16.6 实现资源清理
  - 应用退出时清理系统代理
  - 应用退出时终止 sing-box 进程
  - _需求: 6.4_

- [x] 17. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 18. 端到端测试和验证
- [x] 18.1 在 Windows 上测试完整流程
  - 测试应用启动
  - 测试添加服务器
  - 测试启动/停止代理
  - 测试系统代理设置
  - 测试自启动设置
  - _需求: 所有 Windows 相关需求_

- [x] 18.2 在 macOS Intel (x64) 上测试完整流程
  - 测试应用启动
  - 测试添加服务器
  - 测试启动/停止代理
  - 测试系统代理设置
  - 测试自启动设置
  - 验证 sing-box x64 二进制正常运行
  - _需求: 所有 macOS 相关需求_

- [x] 18.2.1 在 macOS Apple Silicon (arm64) 上测试完整流程
  - 测试应用启动
  - 测试添加服务器
  - 测试启动/停止代理
  - 测试系统代理设置
  - 测试自启动设置
  - 验证 sing-box arm64 二进制正常运行
  - _需求: 所有 macOS 相关需求_

- [ ] 18.3 测试跨平台一致性
  - 验证 UI 在两个平台上一致
  - 验证功能在两个平台上一致
  - _需求: 3.2, 3.4_

- [ ] 19. 最终检查点
  - 确保所有测试通过，如有问题请询问用户
