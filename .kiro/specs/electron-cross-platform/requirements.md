# 需求文档

## 简介

将当前基于 WPF + WebView2 的 Windows 专属 V2rayZ 桌面应用改造为基于 Electron + Node.js 的跨平台应用，支持 Windows 和 macOS 双系统。该改造需要保留现有的 React 前端代码，重写后端服务层为 Node.js，并抽象平台特定的系统调用。

## 术语表

- **Electron**: 基于 Chromium 和 Node.js 的跨平台桌面应用框架
- **主进程 (Main Process)**: Electron 应用的后端进程，运行 Node.js 代码，负责窗口管理和系统调用
- **渲染进程 (Renderer Process)**: Electron 应用的前端进程，运行 React 应用
- **IPC (Inter-Process Communication)**: Electron 主进程和渲染进程之间的通信机制
- **sing-box**: 当前应用使用的代理核心程序
- **v2ray-core**: 另一个可选的代理核心程序
- **系统代理模式 (System Proxy Mode)**: 通过修改系统代理设置来路由流量
- **TUN 模式 (TUN Mode)**: 通过虚拟网卡进行透明代理
- **系统托盘 (System Tray)**: 操作系统任务栏的通知区域图标

## 需求

### 需求 1

**用户故事:** 作为开发者，我希望将现有的 React 前端代码迁移到 Electron 渲染进程，以便在跨平台环境中复用现有的 UI 实现。

#### 验收标准

1. WHEN 启动 Electron 应用 THEN 系统应在主窗口中加载现有的 React 应用
2. WHEN React 应用需要调用后端服务 THEN 系统应通过 Electron IPC 机制与主进程通信
3. WHEN 前端组件渲染 THEN 系统应保持与原 WPF 版本相同的 UI 外观和交互逻辑
4. WHEN 用户与 UI 交互 THEN 系统应正确触发相应的后端操作
5. WHEN 应用窗口关闭 THEN 系统应根据配置最小化到系统托盘或完全退出

### 需求 2

**用户故事:** 作为开发者，我希望使用 Node.js 重写后端服务层，以便在 Electron 主进程中管理代理核心和系统集成。

#### 验收标准

1. WHEN 应用启动 THEN 系统应初始化所有后端服务模块（配置管理、代理管理、统计管理等）
2. WHEN 前端请求启动代理 THEN 系统应启动 sing-box 进程并配置相应的代理模式
3. WHEN 前端请求停止代理 THEN 系统应停止 sing-box 进程并清理系统代理设置
4. WHEN sing-box 进程输出日志 THEN 系统应捕获并解析日志，通过 IPC 发送到前端
5. WHEN sing-box 进程异常退出 THEN 系统应检测退出事件并通知前端更新连接状态

### 需求 3

**用户故事:** 作为开发者，我希望抽象平台特定的系统调用，以便在 Windows 和 macOS 上提供一致的功能接口。

#### 验收标准

1. WHEN 系统需要设置系统代理 THEN 系统应根据当前平台调用相应的系统代理配置方法
2. WHEN 系统需要创建系统托盘图标 THEN 系统应在 Windows 和 macOS 上显示功能一致的托盘菜单
3. WHEN 系统需要设置开机自启动 THEN 系统应使用平台特定的自启动机制
4. WHEN 系统需要获取系统信息 THEN 系统应返回跨平台兼容的系统信息
5. WHEN 系统需要管理 sing-box 二进制文件 THEN 系统应根据平台加载对应的可执行文件

### 需求 4

**用户故事:** 作为开发者，我希望实现配置管理服务，以便在不同平台上持久化和加载用户配置。

#### 验收标准

1. WHEN 应用首次启动 THEN 系统应在用户数据目录创建默认配置文件
2. WHEN 用户修改配置 THEN 系统应验证配置有效性并保存到配置文件
3. WHEN 应用重启 THEN 系统应从配置文件加载用户设置
4. WHEN 配置文件损坏 THEN 系统应使用默认配置并记录错误日志
5. WHEN 配置包含敏感信息 THEN 系统应使用适当的文件权限保护配置文件

### 需求 5

**用户故事:** 作为开发者，我希望实现代理核心管理服务，以便控制 sing-box 进程的生命周期和配置。

#### 验收标准

1. WHEN 用户启动代理连接 THEN 系统应根据用户配置生成 sing-box 配置文件并启动进程
2. WHEN sing-box 进程运行 THEN 系统应持续监控进程状态和输出日志
3. WHEN 用户切换代理模式 THEN 系统应重新生成配置并重启 sing-box 进程
4. WHEN 用户停止代理连接 THEN 系统应优雅地终止 sing-box 进程
5. WHEN sing-box 进程崩溃 THEN 系统应检测崩溃并通知用户

### 需求 6

**用户故事:** 作为开发者，我希望实现系统代理管理服务，以便在不同平台上配置系统级代理设置。

#### 验收标准

1. WHEN 在 Windows 上启用系统代理 THEN 系统应通过注册表修改 Internet Settings 代理配置
2. WHEN 在 macOS 上启用系统代理 THEN 系统应通过 networksetup 命令配置网络服务代理
3. WHEN 禁用系统代理 THEN 系统应恢复原始的系统代理设置
4. WHEN 应用异常退出 THEN 系统应确保系统代理设置被正确清理
5. WHEN 查询代理状态 THEN 系统应返回当前系统代理的启用状态和配置信息

### 需求 7

**用户故事:** 作为开发者，我希望实现日志管理服务，以便收集、存储和展示应用运行日志。

#### 验收标准

1. WHEN 应用运行时产生日志 THEN 系统应将日志写入日志文件并发送到前端
2. WHEN 日志文件过大 THEN 系统应自动轮转日志文件
3. WHEN 用户查看日志 THEN 系统应在前端显示最近的日志条目
4. WHEN 发生错误 THEN 系统应记录详细的错误堆栈信息
5. WHEN 日志级别配置更改 THEN 系统应动态调整日志输出级别

### 需求 8

**用户故事:** 作为开发者，我希望实现协议解析服务，以便支持从 URL 导入服务器配置。

#### 验收标准

1. WHEN 用户输入 VLESS 协议 URL THEN 系统应解析 URL 并提取服务器配置参数
2. WHEN 用户输入 Trojan 协议 URL THEN 系统应解析 URL 并提取服务器配置参数
3. WHEN URL 格式无效 THEN 系统应返回明确的错误信息
4. WHEN URL 包含传输层配置 THEN 系统应正确解析 WebSocket、gRPC 等传输设置
5. WHEN URL 包含 TLS 配置 THEN 系统应正确解析 TLS 相关参数

### 需求 9

**用户故事:** 作为开发者，我希望实现路由规则管理服务，以便支持智能分流和自定义域名规则。

#### 验收标准

1. WHEN 用户选择全局代理模式 THEN 系统应生成将所有流量路由到代理的配置
2. WHEN 用户选择智能分流模式 THEN 系统应生成基于 GeoIP 和 GeoSite 的路由规则
3. WHEN 用户添加自定义域名规则 THEN 系统应将规则集成到 sing-box 配置中
4. WHEN 用户修改路由规则 THEN 系统应重新生成配置并重启代理
5. WHEN 路由规则冲突 THEN 系统应按优先级应用规则并记录警告

### 需求 10

**用户故事:** 作为开发者，我希望实现系统托盘集成，以便用户可以在后台运行应用并快速访问常用功能。

#### 验收标准

1. WHEN 应用启动 THEN 系统应在系统托盘显示应用图标
2. WHEN 用户点击托盘图标 THEN 系统应显示包含常用操作的上下文菜单
3. WHEN 用户从托盘菜单启动代理 THEN 系统应启动代理连接并更新图标状态
4. WHEN 用户关闭主窗口且启用最小化到托盘 THEN 系统应隐藏窗口但保持应用运行
5. WHEN 用户从托盘菜单退出 THEN 系统应清理资源并完全退出应用

### 需求 11

**用户故事:** 作为开发者，我希望实现自启动管理服务，以便用户可以配置应用开机自动启动。

#### 验收标准

1. WHEN 在 Windows 上启用自启动 THEN 系统应在注册表 Run 键中添加应用启动项
2. WHEN 在 macOS 上启用自启动 THEN 系统应使用 Login Items 机制添加启动项
3. WHEN 禁用自启动 THEN 系统应从相应的系统位置移除启动项
4. WHEN 查询自启动状态 THEN 系统应返回当前平台的实际自启动配置状态
5. WHEN 自启动配置失败 THEN 系统应返回错误信息并记录日志

### 需求 12

**用户故事:** 作为开发者，我希望实现构建和打包流程，以便为 Windows 和 macOS 生成可分发的安装包。

#### 验收标准

1. WHEN 执行构建命令 THEN 系统应编译 TypeScript 代码并打包前端资源
2. WHEN 执行打包命令 THEN 系统应为 Windows 生成 NSIS 或 Squirrel 安装程序
3. WHEN 执行打包命令 THEN 系统应为 macOS 生成 DMG 或 PKG 安装包
4. WHEN 打包应用 THEN 系统应包含对应平台的 sing-box 可执行文件和资源文件
5. WHEN 打包完成 THEN 系统应生成包含版本信息和签名的可分发文件

### 需求 13

**用户故事:** 作为开发者，我希望实现错误处理和恢复机制，以便应用在遇到错误时能够优雅降级。

#### 验收标准

1. WHEN 配置文件加载失败 THEN 系统应使用默认配置并通知用户
2. WHEN sing-box 进程启动失败 THEN 系统应显示详细错误信息并提供解决建议
3. WHEN 系统代理设置失败 THEN 系统应回滚更改并记录错误
4. WHEN 网络请求超时 THEN 系统应重试请求或返回友好的错误提示
5. WHEN 未捕获的异常发生 THEN 系统应记录完整堆栈并防止应用崩溃
